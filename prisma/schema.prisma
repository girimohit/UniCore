// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  
  // only use when running "npx prisma validate"
  // url      = env("DATABASE_URL")
}

///////////////////////
// CORE ENUMS
///////////////////////

enum UserRole {
  STUDENT
  FACULTY
  HOD
  ADMIN
  PRINCIPAL
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

///////////////////////
// TENANT
///////////////////////

model Tenant {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  createdAt DateTime @default(now())

  users           User[]
  modules          TenantModule[]
  features         TenantFeature[]
  exams            Exam[]
  roleApprovals    RoleApproval[]
}

///////////////////////
// USERS
///////////////////////

model User {
  id        String   @id @default(uuid())
  clerkId   String?  @unique        // ðŸ”‘ Clerk user ID
  tenantId  String
  email     String
  name      String
  role      UserRole
  wallet    String?          // blockchain wallet (admin only)
  createdAt DateTime @default(now())

  tenant    Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

///////////////////////
// MODULE SYSTEM
///////////////////////

model Module {
  id    String @id @default(uuid())
  code  String @unique
  name  String

  tenants TenantModule[]
}

model TenantModule {
  id        String @id @default(uuid())
  tenantId  String
  moduleId  String
  enabled   Boolean @default(true)

  tenant Tenant @relation(fields: [tenantId], references: [id])
  module Module @relation(fields: [moduleId], references: [id])

  @@unique([tenantId, moduleId])
}

///////////////////////
// FEATURE FLAGS
///////////////////////

model TenantFeature {
  id        String @id @default(uuid())
  tenantId  String
  key       String
  value     String

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, key])
}

///////////////////////
// EXAM MODULE
///////////////////////

model Exam {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  semester  String
  isLocked  Boolean  @default(false)
  createdAt DateTime @default(now())

  tenant   Tenant @relation(fields: [tenantId], references: [id])
  results  ExamResult[]
  lockInfo ResultLock?

  @@index([tenantId])
}

model ExamResult {
  id        String @id @default(uuid())
  examId    String
  studentId String
  marks     Int
  grade     String?

  exam Exam @relation(fields: [examId], references: [id])

  @@unique([examId, studentId])
}

///////////////////////
// RESULT FINALIZATION (BLOCKCHAIN SYNC)
///////////////////////

model ResultLock {
  id            String   @id @default(uuid())
  examId        String   @unique
  resultHash    String   // hash stored on blockchain
  blockchainTx  String   // transaction hash
  approvedBy    String   // userId / wallet reference
  lockedAt      DateTime @default(now())

  exam Exam @relation(fields: [examId], references: [id])
}

///////////////////////
// ROLE & AUTHORITY APPROVAL
///////////////////////

model RoleApproval {
  id            String          @id @default(uuid())
  tenantId      String
  userId        String
  requestedRole UserRole
  status        ApprovalStatus @default(PENDING)
  blockchainTx  String?
  approvedAt    DateTime?

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}
